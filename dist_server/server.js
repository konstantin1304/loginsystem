!function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){t(1),e.exports=t(2)},function(e,r){e.exports=require("@babel/polyfill")},function(e,r,t){function n(e){return function(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function o(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],n=!0,o=!1,s=void 0;try{for(var a,c=e[Symbol.iterator]();!(n=(a=c.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,s=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw s}}return t}}(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}function a(e,r,t,n,o,s,a){try{var c=e[s](a),i=c.value}catch(e){return void t(e)}c.done?r(i):Promise.resolve(i).then(n,o)}function c(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var s=e.apply(r,t);function c(e){a(s,n,o,c,i,"next",e)}function i(e){a(s,n,o,c,i,"throw",e)}c(void 0)})}}function i(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var u=t(3),l=t(4),p=(t(5),t(6)),d=t(7),f=function e(){var r=this;!function(r,t){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this),i(this,"httpServer",null),i(this,"errorCodes",{sqlError:"SQL_ERROR",noSuchCommand:"NO_SUCH_COMMAND",noSuchServerCommand:"NO_SUCH_SERVER_COMMAND",noSuchItem:"NO_SUCH_ITEM_IN_OBJECT"}),i(this,"dbConnection",null),i(this,"contentTypes",{json:{"Content-Type":"application/json"}}),i(this,"httpServerPort",1010),i(this,"postProcessors",{}),i(this,"getProcessors",{}),i(this,"transporter",d.createTransport({service:"gmail",auth:{user:"mailercrud@gmail.com",pass:"a1d2m3i4n"}})),i(this,"initialize",c(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.connectToDb();case 2:r.runHttpServer(),r.initRequestProcessors();case 4:case"end":return e.stop()}},e)}))),i(this,"connectToDb",c(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,p.createConnection({host:"localhost",user:"root",password:"",database:"logssystem"});case 3:r.dbConnection=e.sent,r.setConnectionErrorHandler(r.dbConnection),e.next=12;break;case 7:return e.prev=7,e.t0=e.catch(0),console.error("DB connection failed: ".concat(e.t0.code)),r.dbConnection=null,e.abrupt("return",!1);case 12:case"end":return e.stop()}},e,null,[[0,7]])}))),i(this,"setConnectionErrorHandler",function(e){e.on("error",function(){var e=c(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.dbErrorHandler(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}())}),i(this,"dbErrorHandler",function(){var e=c(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("PROTOCOL_CONNECTION_LOST"!==t.code){e.next=5;break}return r.dbConnection.destroy(),r.dbConnection=null,e.next=5,r.connectToDb();case 5:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()),i(this,"runHttpServer",function(){if(!r.dbConnection)return console.error(new Error("Failed to create server: DB connection is not created.")),!1;r.httpServer=u.createServer(function(e,t){return r.processRequest(e,t)}),r.httpServer.listen(r.httpServerPort,r.httpServerListenLog)}),i(this,"initRequestProcessors",function(){if(!r.dbConnection||!r.httpServer)return console.error("Failed to init processors: DB connection or HTTP server is not created."),!1;r.postProcessors={test:r.testProcessor,save:r.saveProcessor,setting:r.settingProcessor},r.getProcessors={test:r.testProcessor,users:r.userProcessor,auth:r.authProcessor}}),i(this,"httpServerListenLog",function(){console.log(new Date+"\nServer is listening on port "+r.httpServerPort)}),i(this,"processRequest",function(){var e=c(regeneratorRuntime.mark(function e(t,n){var o,s,a,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=l.parse(t.url,!0),s=o.pathname.substring(1),a=o.query,console.log(a),e.t0=t.method,e.next="POST"===e.t0?7:"GET"===e.t0?11:20;break;case 7:return i="",t.on("data",function(e){(i+=e).length>1e6&&t.connection.destroy()}),t.on("end",c(regeneratorRuntime.mark(function e(){var t,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=i,!r.postProcessors[s]){e.next=8;break}return e.next=4,r.postProcessors[s](t);case 4:o=e.sent,r.sendResponse(n,r.contentTypes.json,JSON.stringify(o)),e.next=9;break;case 8:r.sendResponse(n,r.contentTypes.json,JSON.stringify(r.getErrorResponseObject("noSuchCommand",null)));case 9:case"end":return e.stop()}},e)}))),e.abrupt("break",21);case 11:if(!r.getProcessors[s]){e.next=18;break}return e.next=14,r.getProcessors[s](a);case 14:u=e.sent,r.sendResponse(n,r.contentTypes.json,JSON.stringify(u)),e.next=19;break;case 18:r.sendResponse(n,r.contentTypes.json,JSON.stringify(r.getErrorResponseObject("noSuchCommand",null)));case 19:return e.abrupt("break",21);case 20:r.sendResponse(n,r.contentTypes.json,JSON.stringify(r.getErrorResponseObject("noSuchServerCommand",null)));case 21:case"end":return e.stop()}},e)}));return function(r,t){return e.apply(this,arguments)}}()),i(this,"getErrorResponseObject",function(e,t){return{isError:!0,code:r.errorCodes[e],data:t||null}}),i(this,"sendResponse",function(e,r,t){e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Request-Method","*"),e.setHeader("Access-Control-Allow-Methods","*"),e.setHeader("Access-Control-Allow-Headers","*"),e.writeHead(200,r),e.write(t),e.end()}),i(this,"settingProcessor",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("settingProcessor:",t),n=JSON.parse(t),o=n.type,a=s(n,["type"]),e.t0=o,e.next="insertItem"===e.t0?5:"updateItem"===e.t0?7:9;break;case 5:return r.insertItem(a),e.abrupt("break",9);case 7:return r.updateItem(a),e.abrupt("break",9);case 9:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()),i(this,"insertItem",function(){var e=c(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("insertItem:",t),e.t0=t.button,e.next="addItem"===e.t0?4:"updateItem"===e.t0?7:10;break;case 4:return e.next=6,r.settingAddItem(t.data);case 6:return e.abrupt("break",10);case 7:return e.next=9,r.settingAddItemAll(t.data);case 9:return e.abrupt("break",10);case 10:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()),i(this,"settingAddItem",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,a,c,i,u,l,p,d,f,v,b,h,g,m,x,y,E,O,R,k=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=k.length>1&&void 0!==k[1]?k[1]:"version1",e.prev=1,e.next=4,r.dbConnection.execute("SELECT ".concat(n,",id FROM versions"));case 4:a=e.sent,c=o(a,1),i=c[0],u=i,l=!0,p=!1,d=void 0,e.prev=11,f=u[Symbol.iterator]();case 13:if(l=(v=f.next()).done){e.next=33;break}for(x in b=v.value,h=void 0,g=b.id,m=s(b,["id"]))m.hasOwnProperty(x)&&((y=JSON.parse(m[x]))[t]="",h=y);return E=JSON.stringify(h),O="UPDATE versions SET ".concat(n," = '").concat(E,"' WHERE versions.id = '").concat(g,"'"),e.prev=20,e.next=23,r.dbConnection.execute(O);case 23:R=e.sent,console.log(R[0].info),e.next=30;break;case 27:return e.prev=27,e.t0=e.catch(20),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t0.code,": ").concat(e.t0.sqlMessage)));case 30:l=!0,e.next=13;break;case 33:e.next=39;break;case 35:e.prev=35,e.t1=e.catch(11),p=!0,d=e.t1;case 39:e.prev=39,e.prev=40,l||null==f.return||f.return();case 42:if(e.prev=42,!p){e.next=45;break}throw d;case 45:return e.finish(42);case 46:return e.finish(39);case 47:e.next=52;break;case 49:return e.prev=49,e.t2=e.catch(1),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t2.code,": ").concat(e.t2.sqlMessage)));case 52:case"end":return e.stop()}},e,null,[[1,49],[11,35,39,47],[20,27],[40,,42,46]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"settingAddItemAll",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,a,c,i,u,l,p,d,f,v,b,h,g,m,x,y,E;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.dbConnection.execute("SELECT * FROM versions");case 3:n=e.sent,a=o(n,1),c=a[0],i=c,u=!0,l=!1,p=void 0,e.prev=10,d=i[Symbol.iterator]();case 12:if(u=(f=d.next()).done){e.next=38;break}v=f.value,b=v.id,v.name,h=s(v,["id","name"]),e.t0=regeneratorRuntime.keys(h);case 16:if((e.t1=e.t0()).done){e.next=35;break}if(g=e.t1.value,!h.hasOwnProperty(g)){e.next=33;break}return(m=JSON.parse(h[g]))[t]="",x=JSON.stringify(m),y="UPDATE versions SET ".concat(g," = '").concat(x,"' WHERE versions.id = '").concat(b,"'"),e.prev=23,e.next=26,r.dbConnection.execute(y);case 26:E=e.sent,console.log(E[0].info),e.next=33;break;case 30:return e.prev=30,e.t2=e.catch(23),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t2.code,": ").concat(e.t2.sqlMessage)));case 33:e.next=16;break;case 35:u=!0,e.next=12;break;case 38:e.next=44;break;case 40:e.prev=40,e.t3=e.catch(10),l=!0,p=e.t3;case 44:e.prev=44,e.prev=45,u||null==d.return||d.return();case 47:if(e.prev=47,!l){e.next=50;break}throw p;case 50:return e.finish(47);case 51:return e.finish(44);case 52:e.next=57;break;case 54:return e.prev=54,e.t4=e.catch(0),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t4.code,": ").concat(e.t4.sqlMessage)));case 57:case"end":return e.stop()}},e,null,[[0,54],[10,40,44,52],[23,30],[45,,47,51]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"updateItem",function(e){switch(console.log("updateItem:",e),e.button){case"addItem":r.settingUpdateItem(e.data);break;case"addEverywhere":r.settingUpdateItemAll(e.data)}}),i(this,"settingUpdateItem",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,a,c,i,u,l,p,d,f,v,b,h,g,m,x,y,E,O,R,k,w,S=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=S.length>1&&void 0!==S[1]?S[1]:"version1",console.log("settingUpdateItem",t),a=t.oldItem,c=t.newItem,console.log("oldItem",a),console.log("newItem",c),e.prev=5,e.next=8,r.dbConnection.execute("SELECT ".concat(n,",id FROM versions"));case 8:i=e.sent,u=o(i,1),l=u[0],p=l,d=!0,f=!1,v=void 0,e.prev=15,b=p[Symbol.iterator]();case 17:if(d=(h=b.next()).done){e.next=48;break}g=h.value,m=void 0,x=g.id,y=s(g,["id"]),e.t0=regeneratorRuntime.keys(y);case 22:if((e.t1=e.t0()).done){e.next=33;break}if(E=e.t1.value,!y.hasOwnProperty(E)){e.next=31;break}if((O=JSON.parse(y[E]))[a]){e.next=28;break}return e.abrupt("return",console.error("ITEM NOT FOUND"));case 28:O[c]=O[a],delete O[a],m=O;case 31:e.next=22;break;case 33:return R=JSON.stringify(m),k="UPDATE versions SET ".concat(n," = '").concat(R,"' WHERE versions.id = '").concat(x,"'"),e.prev=35,e.next=38,r.dbConnection.execute(k);case 38:w=e.sent,console.log(w[0].info),e.next=45;break;case 42:return e.prev=42,e.t2=e.catch(35),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t2.code,": ").concat(e.t2.sqlMessage)));case 45:d=!0,e.next=17;break;case 48:e.next=54;break;case 50:e.prev=50,e.t3=e.catch(15),f=!0,v=e.t3;case 54:e.prev=54,e.prev=55,d||null==b.return||b.return();case 57:if(e.prev=57,!f){e.next=60;break}throw v;case 60:return e.finish(57);case 61:return e.finish(54);case 62:e.next=67;break;case 64:return e.prev=64,e.t4=e.catch(5),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t4.code,": ").concat(e.t4.sqlMessage)));case 67:case"end":return e.stop()}},e,null,[[5,64],[15,50,54,62],[35,42],[55,,57,61]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"settingUpdateItemAll",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,a,c,i,u,l,p,d,f,v,b,h,g,m,x,y,E,O,R;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("settingAddItemAll",t),n=t.oldItem,a=t.newItem,e.prev=2,e.next=5,r.dbConnection.execute("SELECT * FROM versions");case 5:c=e.sent,i=o(c,1),u=i[0],l=u,p=!0,d=!1,f=void 0,e.prev=12,v=l[Symbol.iterator]();case 14:if(p=(b=v.next()).done){e.next=43;break}h=b.value,g=h.id,h.name,m=s(h,["id","name"]),e.t0=regeneratorRuntime.keys(m);case 18:if((e.t1=e.t0()).done){e.next=40;break}if(x=e.t1.value,!m.hasOwnProperty(x)){e.next=38;break}if((y=JSON.parse(m[x]))[n]){e.next=24;break}return e.abrupt("return",console.error("ITEM NOT FOUND"));case 24:return y[a]=y[n],delete y[n],E=JSON.stringify(y),O="UPDATE versions SET ".concat(x," = '").concat(E,"' WHERE versions.id = '").concat(g,"'"),e.prev=28,e.next=31,r.dbConnection.execute(O);case 31:R=e.sent,console.log(R[0].info),e.next=38;break;case 35:return e.prev=35,e.t2=e.catch(28),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t2.code,": ").concat(e.t2.sqlMessage)));case 38:e.next=18;break;case 40:p=!0,e.next=14;break;case 43:e.next=49;break;case 45:e.prev=45,e.t3=e.catch(12),d=!0,f=e.t3;case 49:e.prev=49,e.prev=50,p||null==v.return||v.return();case 52:if(e.prev=52,!d){e.next=55;break}throw f;case 55:return e.finish(52);case 56:return e.finish(49);case 57:e.next=62;break;case 59:return e.prev=59,e.t4=e.catch(2),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t4.code,": ").concat(e.t4.sqlMessage)));case 62:case"end":return e.stop()}},e,null,[[2,59],[12,45,49,57],[28,35],[50,,52,56]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"userProcessor",function(){var e=c(regeneratorRuntime.mark(function e(t){var s,a,c,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("userProcessor queryArgs:",t),s=null,e.prev=2,e.next=5,r.dbConnection.execute("SELECT * FROM versions");case 5:a=e.sent,c=o(a,1),i=c[0],s=i,e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(2),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t0.code,": ").concat(e.t0.sqlMessage)));case 14:return e.abrupt("return",{isError:!1,data:n(s)});case 15:case"end":return e.stop()}},e,null,[[2,11]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"authProcessor",function(){var e=c(regeneratorRuntime.mark(function e(t){var s,a,c,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("queryArgs:",t),s=t.userName,t.password,a=null,e.prev=3,e.next=6,r.dbConnection.execute("SELECT userName FROM users WHERE userName='".concat(s,"'"));case 6:c=e.sent,i=o(c,1),u=i[0],a=u,e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(3),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t0.code,": ").concat(e.t0.sqlMessage)));case 15:return e.abrupt("return",{isError:!1,data:n(a)});case 16:case"end":return e.stop()}},e,null,[[3,12]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"saveProcessor",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,o,a,c,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("saveProcessor:",t),n=JSON.parse(t),o=n.id,a=s(n,["id"]),c=JSON.stringify(a),i="merge"===n.type?"UPDATE versions SET version1='".concat(c,"',version2='").concat(c,"', \n            version3='").concat(c,"',version4='").concat(c,"' WHERE versions.id = ").concat(o):"UPDATE versions SET ".concat(n.version," = '").concat(c,"' WHERE versions.id = '").concat(o,"'"),e.prev=5,e.next=8,r.dbConnection.execute(i);case 8:e.sent,e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(5),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t0.code,": ").concat(e.t0.sqlMessage)));case 14:return r.sendLogsOnEmail(n),e.abrupt("return",{isError:!1,data:!0});case 16:case"end":return e.stop()}},e,null,[[5,11]])}));return function(r){return e.apply(this,arguments)}}()),i(this,"sendLogsOnEmail",function(){var e=c(regeneratorRuntime.mark(function e(t){var n,s,a,c,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return console.error("Failed to send message"),e.abrupt("return",!1);case 3:return e.prev=3,e.next=6,r.dbConnection.execute("SELECT email FROM person_update_email");case 6:s=e.sent,a=o(s,1),n=a[0],e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(3),e.abrupt("return",r.getErrorResponseObject("sqlError","".concat(e.t0.code,": ").concat(e.t0.sqlMessage)));case 14:c=n.map(function(e){return e.email}),console.log(c),i=new Date,u={from:"mailercrud@gmail.com",to:c,subject:"New changes in database",html:'<table border="1">\n                            <thead>\n                                <th>id</th>\n                                <th>Name</th>\n                                <th>DataVal</th>\n                                <th>Val</th>\n                                <th>Change value</th>\n                                <th>Value</th>\n                            </thead>\n                            <tbody>\n                            <tr>\n                                <td>'.concat(t.id,"</td>\n                                <td>root</td>\n                                <td>").concat(i,'</td>\n                                <td>Last name</td>\n                                <td style="color:green">').concat(t.name,'</td>\n                                <td style="color:red">Ivanova</td>\n                             </tr>   \n                            </tbody>\n                            </table>')},r.transporter.sendMail(u,function(e,r){e?console.log(e):console.log("Email sent: "+r.response)});case 19:case"end":return e.stop()}},e,null,[[3,11]])}));return function(r){return e.apply(this,arguments)}}())};console.log("Production status: ".concat(!0,".")),c(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new f,e.next=3,r.initialize();case 3:case"end":return e.stop()}},e)}))()},function(e,r){e.exports=require("http")},function(e,r){e.exports=require("url")},function(e,r){e.exports=require("querystring")},function(e,r){e.exports=require("mysql2/promise")},function(e,r){e.exports=require("nodemailer")}]);